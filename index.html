<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Conditional Markets Viewer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="alpha-banner">
        <strong>ALPHA SOFTWARE</strong> - May contain bugs. Known limitations include limit order handling.
        Always use <em>Validate</em> before placing bets. API key is stored in browser localStorage -
        don't use on shared computers.
    </div>
    <div class="container">
        <header>
            <h1>Conditional Markets Viewer</h1>
            <p class="subtitle">View and bet on joint probability markets</p>
        </header>

        <section class="controls">
            <div class="control-group">
                <label for="market-select">Select Market:</label>
                <select id="market-select">
                    <option value="">-- Choose a market --</option>
                </select>
                <button id="refresh-btn" title="Refresh market data">Refresh</button>
            </div>

            <div class="control-group api-key-group">
                <label for="api-key">API Key:</label>
                <div class="api-key-input">
                    <input type="password" id="api-key" placeholder="Enter Manifold API key for betting">
                    <button id="toggle-key-visibility" title="Show/hide key">Show</button>
                    <button id="clear-key" title="Clear saved key">Clear</button>
                </div>
                <span class="api-key-status" id="api-key-status"></span>
            </div>
        </section>

        <section id="market-info" class="market-info hidden">
            <h2 id="market-title"></h2>
            <a id="market-link" href="#" target="_blank">View on Manifold</a>
        </section>

        <section id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Loading market data...</p>
        </section>

        <section id="error" class="error hidden">
            <p id="error-message"></p>
        </section>

        <section id="matrix-container" class="matrix-container hidden">
            <!-- Full confusion matrix with conditionals on edges -->
            <div class="full-matrix">
                <div class="matrix-grid">
                    <!-- Row 0: Headers -->
                    <div class="cell corner"></div>
                    <div class="cell col-header" id="col-header-b">B</div>
                    <div class="cell col-header" id="col-header-not-b">~B</div>
                    <div class="cell marginal-header">P(Row)</div>
                    <div class="cell cond-header">B|?</div>

                    <!-- Row 1: A row - right edge shows P(B|A) -->
                    <div class="cell row-header" id="row-header-a">A</div>
                    <div class="cell joint clickable" id="cell-a-b" data-cell="a_yes_b_yes">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell joint clickable" id="cell-a-not-b" data-cell="a_yes_b_no">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell marginal clickable" id="marginal-a" data-marginal="a">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell conditional clickable" data-cond="b_given_a">
                        <span class="cond-label">B|A</span>
                        <span class="cond-value" id="cond-b-given-a">--</span>
                    </div>

                    <!-- Row 2: ~A row - right edge shows P(B|~A) -->
                    <div class="cell row-header" id="row-header-not-a">~A</div>
                    <div class="cell joint clickable" id="cell-not-a-b" data-cell="a_no_b_yes">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell joint clickable" id="cell-not-a-not-b" data-cell="a_no_b_no">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell marginal clickable" id="marginal-not-a" data-marginal="not_a">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell conditional clickable" data-cond="b_given_not_a">
                        <span class="cond-label">B|~A</span>
                        <span class="cond-value" id="cond-b-given-not-a">--</span>
                    </div>

                    <!-- Row 3: Column marginals -->
                    <div class="cell marginal-header">P(Col)</div>
                    <div class="cell marginal clickable" id="marginal-b" data-marginal="b">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell marginal clickable" id="marginal-not-b" data-marginal="not_b">
                        <span class="prob-value"></span>
                    </div>
                    <div class="cell total" id="total-sum">
                        <span class="prob-value">1.00</span>
                    </div>
                    <div class="cell empty"></div>

                    <!-- Row 4: Column conditionals - bottom shows P(A|B) -->
                    <div class="cell cond-header">A|?</div>
                    <div class="cell conditional clickable" data-cond="a_given_b">
                        <span class="cond-label">A|B</span>
                        <span class="cond-value" id="cond-a-given-b">--</span>
                    </div>
                    <div class="cell conditional clickable" data-cond="a_given_not_b">
                        <span class="cond-label">A|~B</span>
                        <span class="cond-value" id="cond-a-given-not-b">--</span>
                    </div>
                    <div class="cell empty"></div>
                    <div class="cell empty"></div>
                </div>
            </div>

            <!-- Inline bet panel (shows when cell is clicked) -->
            <div id="bet-panel" class="bet-panel hidden">
                <div class="bet-panel-header">
                    <h3 id="bet-panel-title">Bet on Cell</h3>
                    <button class="close-panel-btn" id="close-bet-panel">&times;</button>
                </div>
                <div class="bet-panel-body">
                    <p id="bet-panel-description"></p>

                    <div class="bet-direction-row" id="bet-direction-row">
                        <label>Direction:</label>
                        <div class="direction-toggle">
                            <button class="direction-btn active" data-direction="yes">YES (higher)</button>
                            <button class="direction-btn" data-direction="no">NO (lower)</button>
                        </div>
                    </div>

                    <div class="bet-input-row">
                        <label for="panel-bet-amount">Amount (M$):</label>
                        <input type="number" id="panel-bet-amount" min="1" value="10" step="1">
                        <button id="panel-validate-btn" class="btn-secondary" title="Compare to API dry-run">Validate</button>
                        <button id="panel-execute-bet" class="btn-primary">Place Bet</button>
                    </div>

                    <div class="trade-preview" id="trade-preview">
                        <h4>Trade Plan <span id="validation-status" class="validation-status"></span></h4>
                        <div class="trade-plan" id="trade-plan">
                            <!-- Trade steps will be inserted here -->
                        </div>
                        <div class="trade-summary" id="trade-summary">
                            <!-- Summary will be inserted here -->
                        </div>
                        <div id="validation-details" class="validation-details hidden">
                            <!-- Validation results will be inserted here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Derived stats -->
            <div class="stats-section">
                <h3>Derived Statistics</h3>
                <div class="stats-grid">
                    <div class="stat-item">
                        <span class="stat-label">Correlation (A,B)</span>
                        <span class="stat-value" id="stat-correlation">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Lift P(A|B)/P(A)</span>
                        <span class="stat-value" id="stat-lift-a">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Lift P(B|A)/P(B)</span>
                        <span class="stat-value" id="stat-lift-b">--</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Odds Ratio</span>
                        <span class="stat-value" id="stat-odds-ratio">--</span>
                    </div>
                </div>
            </div>

            <!-- Correlation Betting Panel -->
            <div class="correlation-section">
                <div id="correlation-header" class="correlation-header">
                    <h3>Correlation Betting</h3>
                    <button id="correlation-toggle" class="toggle-btn">â–¼</button>
                </div>
                <div id="correlation-content" class="correlation-content">
                    <p class="correlation-explainer">
                        Bet on correlation between A and B while maintaining market-neutral exposure to each marginal (for small trades).
                        Long correlation profits if both happen or neither; short profits on mixed outcomes.
                    </p>

                    <div class="correlation-controls">
                        <div class="control-row">
                            <label>Direction:</label>
                            <div class="direction-toggle">
                                <button class="corr-direction-btn active" data-direction="long">Long Correlation</button>
                                <button class="corr-direction-btn" data-direction="short">Short Correlation</button>
                            </div>
                        </div>
                        <div class="control-row">
                            <label for="corr-scale">Max Shares:</label>
                            <input type="number" id="corr-scale" min="1" value="10" step="1">
                            <button id="corr-calculate" class="btn-secondary">Calculate</button>
                        </div>
                    </div>

                    <div id="correlation-results" class="correlation-results hidden">
                        <div class="corr-position-table">
                            <h4>Position (YES shares)</h4>
                            <div class="corr-position-grid">
                                <div class="corr-pos-cell header"></div>
                                <div class="corr-pos-cell header" id="corr-col-b">B</div>
                                <div class="corr-pos-cell header" id="corr-col-not-b">~B</div>
                                <div class="corr-pos-cell header" id="corr-row-a">A</div>
                                <div class="corr-pos-cell value diagonal" id="corr-pos-ab">--</div>
                                <div class="corr-pos-cell value" id="corr-pos-anb">--</div>
                                <div class="corr-pos-cell header" id="corr-row-not-a">~A</div>
                                <div class="corr-pos-cell value" id="corr-pos-nab">--</div>
                                <div class="corr-pos-cell value diagonal" id="corr-pos-nanb">--</div>
                            </div>
                        </div>

                        <div class="corr-trade-plan">
                            <h4>Trade Plan (lowest prob first)</h4>
                            <div id="corr-trade-steps"></div>
                        </div>

                        <div class="corr-summary">
                            <div class="summary-row">
                                <span class="summary-label">Total Cost:</span>
                                <span class="summary-value" id="corr-total-cost">--</span>
                            </div>
                            <div class="summary-row">
                                <span class="summary-label">E[profit] at post-trade prices:</span>
                                <span class="summary-value" id="corr-expected-profit">--</span>
                            </div>
                            <div id="corr-min-bet-warning" class="min-bet-warning hidden">
                                Some bets are below M$1 minimum. Increase scale or use fewer cells.
                            </div>
                        </div>

                        <div class="corr-actions">
                            <button id="corr-validate-btn" class="btn-secondary" disabled>Validate</button>
                            <button id="corr-execute-btn" class="btn-primary" disabled>Place Correlation Bet</button>
                            <span id="corr-execute-status" class="execute-status"></span>
                        </div>

                        <div class="corr-neutrality">
                            <h4>Neutrality Check</h4>
                            <div class="neutrality-grid">
                                <div class="neutrality-row">
                                    <span class="neutrality-label">E[payout | A]:</span>
                                    <span class="neutrality-value" id="corr-payout-a">--</span>
                                </div>
                                <div class="neutrality-row">
                                    <span class="neutrality-label">E[payout | ~A]:</span>
                                    <span class="neutrality-value" id="corr-payout-not-a">--</span>
                                </div>
                                <div class="neutrality-row">
                                    <span class="neutrality-label">E[payout | B]:</span>
                                    <span class="neutrality-value" id="corr-payout-b">--</span>
                                </div>
                                <div class="neutrality-row">
                                    <span class="neutrality-label">E[payout | ~B]:</span>
                                    <span class="neutrality-value" id="corr-payout-not-b">--</span>
                                </div>
                            </div>
                            <div id="corr-neutrality-status" class="neutrality-status"></div>
                        </div>

                        <div class="corr-profit-table">
                            <h4>Profit by Belief (diagonal probability shift)</h4>
                            <div id="corr-profit-scenarios"></div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Bet Dialog -->
        <div id="bet-dialog" class="dialog-overlay hidden">
            <div class="dialog">
                <div class="dialog-header">
                    <h3 id="bet-dialog-title">Conditional Bet</h3>
                    <button class="close-btn" id="close-bet-dialog">&times;</button>
                </div>
                <div class="dialog-body">
                    <p id="bet-description"></p>

                    <div class="bet-input-group">
                        <label for="bet-amount">Total Amount (M$):</label>
                        <input type="number" id="bet-amount" min="1" value="10" step="1">
                    </div>

                    <div class="hedge-preview" id="hedge-preview">
                        <h4>Hedge Strategy Preview</h4>
                        <div class="hedge-details" id="hedge-details"></div>
                    </div>

                    <div class="payout-preview" id="payout-preview">
                        <h4>Expected Payouts</h4>
                        <div class="payout-scenarios" id="payout-scenarios"></div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button id="cancel-bet" class="btn-secondary">Cancel</button>
                    <button id="execute-bet" class="btn-primary">Place Bet</button>
                </div>
            </div>
        </div>

        <!-- Bet Result Dialog -->
        <div id="result-dialog" class="dialog-overlay hidden">
            <div class="dialog">
                <div class="dialog-header">
                    <h3 id="result-dialog-title">Bet Result</h3>
                    <button class="close-btn" id="close-result-dialog">&times;</button>
                </div>
                <div class="dialog-body">
                    <div id="result-content"></div>
                </div>
                <div class="dialog-footer">
                    <button id="close-result" class="btn-primary">OK</button>
                </div>
            </div>
        </div>

        <!-- Market Configuration Dialog -->
        <div id="config-dialog" class="dialog-overlay hidden">
            <div class="dialog config-dialog">
                <div class="dialog-header">
                    <h3>Configure Market</h3>
                    <button class="close-btn" id="close-config-dialog">&times;</button>
                </div>
                <div class="dialog-body">
                    <!-- Step 1: Enter slug -->
                    <div id="config-step-slug" class="config-step">
                        <div class="config-input-row">
                            <label for="config-slug">Market Slug:</label>
                            <input type="text" id="config-slug" placeholder="e.g., will-trump-win-2024">
                            <button id="config-fetch-btn" class="btn-primary">Fetch</button>
                        </div>
                        <p class="config-hint">Enter the slug from a Manifold market URL</p>
                        <div id="config-fetch-error" class="config-error hidden"></div>
                    </div>

                    <!-- Step 2: Map answers (shown after fetch) -->
                    <div id="config-step-map" class="config-step hidden">
                        <h4 id="config-market-title"></h4>

                        <div class="config-labels">
                            <div class="config-label-input">
                                <label for="config-label-a">Label A (rows):</label>
                                <input type="text" id="config-label-a" placeholder="e.g., Trump wins">
                            </div>
                            <div class="config-label-input">
                                <label for="config-label-b">Label B (columns):</label>
                                <input type="text" id="config-label-b" placeholder="e.g., GOP Senate">
                            </div>
                        </div>

                        <div class="config-answers">
                            <p>Map each answer to a grid cell:</p>
                            <div id="config-answer-list">
                                <!-- Answer mapping rows inserted by JS -->
                            </div>
                        </div>

                        <div id="config-map-error" class="config-error hidden"></div>
                    </div>
                </div>
                <div class="dialog-footer">
                    <button id="config-cancel" class="btn-secondary">Cancel</button>
                    <button id="config-save" class="btn-primary" disabled>Save & Load</button>
                </div>
            </div>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>
